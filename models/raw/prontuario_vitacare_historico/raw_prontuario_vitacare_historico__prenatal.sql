{{
    config(
        alias="prenatal", 
        materialized="table",
        schema="brutos_prontuario_vitacare_historico",
    )
}}

WITH

    source_prenatal AS (
        SELECT 
            CONCAT(
                NULLIF({{ remove_double_quotes('id_cnes') }}, ''), 
                '.',
                NULLIF({{ remove_double_quotes('acto_id') }}, '')
            ) AS id_prontuario_global,
            *
        FROM {{ source('brutos_prontuario_vitacare_historico', 'PRENATAL') }} 
    ),


      -- Using window function to deduplicate prenatal
    prenatal_deduplicados AS (
        SELECT
            *
        FROM (
            SELECT
                *,
                ROW_NUMBER() OVER (PARTITION BY id_prontuario_global ORDER BY extracted_at DESC) AS rn
            FROM source_prenatal
        )
        WHERE rn = 1
    ),

    fato_prenatal AS (
        SELECT
            -- PKs e Chaves
            id_prontuario_global,
            {{ remove_double_quotes('acto_id') }} AS id_prontuario_local,
            {{ remove_double_quotes('id_cnes') }} AS cnes_unidade,

            {{ process_null(remove_double_quotes('param_peso')) }} AS param_peso,
            {{ process_null(remove_double_quotes('param_tamin')) }} AS param_tamin,
            {{ process_null(remove_double_quotes('param_tamax')) }} AS param_tamax,
            {{ process_null(remove_double_quotes('consseguintes_afu')) }} AS consseguintes_afu,
            {{ process_null(remove_double_quotes('edema')) }} AS edema,
            {{ process_null(remove_double_quotes('observacoes')) }} AS observacoes,
            {{ process_null(remove_double_quotes('pconsulta_peso_habitual')) }} AS pconsulta_peso_habitual,
            {{ process_null(remove_double_quotes('pconsulta_altura')) }} AS pconsulta_altura,
            {{ process_null(remove_double_quotes('pconsulta_idade_gestacional')) }} AS pconsulta_idade_gestacional,
            {{ process_null(remove_double_quotes('grupo_sanguineo_gravida')) }} AS grupo_sanguineo_gravida,
            {{ process_null(remove_double_quotes('pconsulta_grupo_sanguineo_pai')) }} AS pconsulta_grupo_sanguineo_pai,
            {{ process_null(remove_double_quotes('consseguintes_afuobs')) }} AS consseguintes_afuobs,
            {{ process_null(remove_double_quotes('pelvimetria_clinica')) }} AS pelvimetria_clinica,
            {{ process_null(remove_double_quotes('agraval_risco_prenatal_histo_reprod')) }} AS agraval_risco_prenatal_histo_reprod,
            {{ process_null(remove_double_quotes('agraval_risco_prenatal_histo_obstet_anterior')) }} AS agraval_risco_prenatal_histo_obstet_anterior,
            {{ process_null(remove_double_quotes('agraval_risco_prenatal_patol_associada')) }} AS agraval_risco_prenatal_patol_associada,
            {{ process_null(remove_double_quotes('agraval_risco_prenatal_gravidez_actual')) }} AS agraval_risco_prenatal_gravidez_actual,
            {{ process_null(remove_double_quotes('aval_risco_prenatal_total_indices')) }} AS aval_risco_prenatal_total_indices,
            {{ process_null(remove_double_quotes('agraval_risco_prenatal_escala_nunomont')) }} AS agraval_risco_prenatal_escala_nunomont,
            {{ process_null(remove_double_quotes('exames_lab_glicemia_pos_50')) }} AS exames_lab_glicemia_pos_50,
            {{ process_null(remove_double_quotes('exames_lab_tcoombs')) }} AS exames_lab_tcoombs,
            {{ process_null(remove_double_quotes('exames_lab_glicemia_jejum')) }} AS exames_lab_glicemia_jejum,
            {{ process_null(remove_double_quotes('exames_lab_ptgo_0')) }} AS exames_lab_ptgo_0,
            {{ process_null(remove_double_quotes('exames_lab_ptgo_60')) }} AS exames_lab_ptgo_60,
            {{ process_null(remove_double_quotes('exames_lab_ptg_120')) }} AS exames_lab_ptg_120,
            {{ process_null(remove_double_quotes('exames_lab_ptg_180')) }} AS exames_lab_ptg_180,
            {{ process_null(remove_double_quotes('exames_lab_creatinemia')) }} AS exames_lab_creatinemia,
            {{ process_null(remove_double_quotes('exames_lab_vdrl')) }} AS exames_lab_vdrl,
            {{ process_null(remove_double_quotes('exames_lab_toxoplasmose_imun')) }} AS exames_lab_toxoplasmose_imun,
            {{ process_null(remove_double_quotes('exames_lab_rubeola_igg')) }} AS exames_lab_rubeola_igg,
            {{ process_null(remove_double_quotes('exames_lab_rubeola_igm')) }} AS exames_lab_rubeola_igm,
            {{ process_null(remove_double_quotes('exames_lab_rubeola_imun')) }} AS exames_lab_rubeola_imun,
            {{ process_null(remove_double_quotes('exames_lab_aghbs')) }} AS exames_lab_aghbs,
            {{ process_null(remove_double_quotes('exames_lab_hiv')) }} AS exames_lab_hiv,
            {{ process_null(remove_double_quotes('exames_lab_urocultura')) }} AS exames_lab_urocultura,
            {{ process_null(remove_double_quotes('exames_lab_urocultura_positiva')) }} AS exames_lab_urocultura_positiva,
            {{ process_null(remove_double_quotes('exame_clinic_mama_esq_inspeccao')) }} AS exame_clinic_mama_esq_inspeccao,
            {{ process_null(remove_double_quotes('exame_clini_cmama_esq_palpacao')) }} AS exame_clini_cmama_esq_palpacao,
            {{ process_null(remove_double_quotes('exame_clinic_mama_dir_inspeccao')) }} AS exame_clinic_mama_dir_inspeccao,
            {{ process_null(remove_double_quotes('exame_clinic_mama_dir_palpacao')) }} AS exame_clinic_mama_dir_palpacao,
            {{ process_null(remove_double_quotes('exame_ginec_vulva_vagina')) }} AS exame_ginec_vulva_vagina,
            {{ process_null(remove_double_quotes('colo_utero_exame')) }} AS colo_utero_exame,
            {{ process_null(remove_double_quotes('colo_utero_toque')) }} AS colo_utero_toque,
            {{ process_null(remove_double_quotes('exame_citologiares')) }} AS exame_citologiares,
            {{ process_null(remove_double_quotes('pconsulta_dum1')) }} AS pconsulta_dum1,
            {{ process_null(remove_double_quotes('pconsulta_dpp1')) }} AS pconsulta_dpp1,
            {{ process_null(remove_double_quotes('agraval_risco_prenatal_obs')) }} AS agraval_risco_prenatal_obs,
            {{ process_null(remove_double_quotes('pconsulta_idade_gestacional_dias')) }} AS pconsulta_idade_gestacional_dias,
            {{ process_null(remove_double_quotes('exame_clinic_mama_esq_inspeccao_obs')) }} AS exame_clinic_mama_esq_inspeccao_obs,
            {{ process_null(remove_double_quotes('exame_clinic_mama_dir_inspeccao_obs')) }} AS exame_clinic_mama_dir_inspeccao_obs,
            {{ process_null(remove_double_quotes('exame_clinic_mama_esq_palpacao_obs')) }} AS exame_clinic_mama_esq_palpacao_obs,
            {{ process_null(remove_double_quotes('exame_clinic_mama_dir_palpacao_obs')) }} AS exame_clinic_mama_dir_palpacao_obs,
            {{ process_null(remove_double_quotes('queixas_mam')) }} AS queixas_mam,
            {{ process_null(remove_double_quotes('analises_eritrocitos')) }} AS analises_eritrocitos,
            {{ process_null(remove_double_quotes('analises_hemoglobina')) }} AS analises_hemoglobina,
            {{ process_null(remove_double_quotes('analises_hematocrito')) }} AS analises_hematocrito,
            {{ process_null(remove_double_quotes('analises_gm')) }} AS analises_gm,
            {{ process_null(remove_double_quotes('analises_hgm')) }} AS analises_hgm,
            {{ process_null(remove_double_quotes('analises_chgm')) }} AS analises_chgm,
            {{ process_null(remove_double_quotes('analises_leucocitos')) }} AS analises_leucocitos,
            {{ process_null(remove_double_quotes('analises_neutrifilos')) }} AS analises_neutrifilos,
            {{ process_null(remove_double_quotes('analises_eosinofilos')) }} AS analises_eosinofilos,
            {{ process_null(remove_double_quotes('analises_basofilos')) }} AS analises_basofilos,
            {{ process_null(remove_double_quotes('analises_linfocitos')) }} AS analises_linfocitos,
            {{ process_null(remove_double_quotes('analises_monocitos')) }} AS analises_monocitos,
            {{ process_null(remove_double_quotes('cseguintes_alalises_plaquetas')) }} AS cseguintes_alalises_plaquetas,
            {{ process_null(remove_double_quotes('cseguintes_alalises_acidourico')) }} AS cseguintes_alalises_acidourico,
            {{ process_null(remove_double_quotes('cseguintes_alalises_citomegalo_virus')) }} AS cseguintes_alalises_citomegalo_virus,
            {{ process_null(remove_double_quotes('cseguintes_alalises_achbs')) }} AS cseguintes_alalises_achbs,
            {{ process_null(remove_double_quotes('cseguintes_alalises_achbc')) }} AS cseguintes_alalises_achbc,
            {{ process_null(remove_double_quotes('cseguintes_alalises_achvc')) }} AS cseguintes_alalises_achvc,
            {{ process_null(remove_double_quotes('cseguintes_alalises_alfa_proteina')) }} AS cseguintes_alalises_alfa_proteina,
            {{ process_null(remove_double_quotes('cseguintes_alalises_inibinaa')) }} AS cseguintes_alalises_inibinaa,
            {{ process_null(remove_double_quotes('cseguintes_alalises_estradiol')) }} AS cseguintes_alalises_estradiol,
            {{ process_null(remove_double_quotes('cseguintes_alalises_hormona_beta_corionica')) }} AS cseguintes_alalises_hormona_beta_corionica,
            {{ process_null(remove_double_quotes('cseguintes_alalises_tempo_protrombina')) }} AS cseguintes_alalises_tempo_protrombina,
            {{ process_null(remove_double_quotes('cseguintes_alalises_ttrombo_plastina_parcial')) }} AS cseguintes_alalises_ttrombo_plastina_parcial,
            {{ process_null(remove_double_quotes('cseguintes_alalises_ecografia_obstetrica')) }} AS cseguintes_alalises_ecografia_obstetrica,
            {{ process_null(remove_double_quotes('alalises_eco_obstet_morfologica')) }} AS alalises_eco_obstet_morfologica,
            {{ process_null(remove_double_quotes('exame_citologia_resrccu')) }} AS exame_citologia_resrccu,
            {{ process_null(remove_double_quotes('pconsulta_dum1dias')) }} AS pconsulta_dum1dias,
            {{ process_null(remove_double_quotes('data_mamografia')) }} AS data_mamografia,
            {{ process_null(remove_double_quotes('res_mamografias')) }} AS res_mamografias,
            {{ process_null(remove_double_quotes('analises_combur_combur')) }} AS analises_combur_combur,
            {{ process_null(remove_double_quotes('analises_combur_bilirrubina')) }} AS analises_combur_bilirrubina,
            {{ process_null(remove_double_quotes('analises_combur_urobilogenio')) }} AS analises_combur_urobilogenio,
            {{ process_null(remove_double_quotes('analises_combur_cetonas')) }} AS analises_combur_cetonas,
            {{ process_null(remove_double_quotes('analises_combur_glucose')) }} AS analises_combur_glucose,
            {{ process_null(remove_double_quotes('analises_combur_proteinas')) }} AS analises_combur_proteinas,
            {{ process_null(remove_double_quotes('analises_combur_sangue')) }} AS analises_combur_sangue,
            {{ process_null(remove_double_quotes('analises_combur_nitritos')) }} AS analises_combur_nitritos,
            {{ process_null(remove_double_quotes('analises_combur_ph')) }} AS analises_combur_ph,
            {{ process_null(remove_double_quotes('analises_combur_densidade')) }} AS analises_combur_densidade,
            {{ process_null(remove_double_quotes('analises_combur_leucocitos')) }} AS analises_combur_leucocitos,
            {{ process_null(remove_double_quotes('exames_lab_urocultur_ancolonias')) }} AS exames_lab_urocultur_ancolonias,
            {{ process_null(remove_double_quotes('data_resultado_citologia')) }} AS data_resultado_citologia,
            {{ process_null(remove_double_quotes('pconsulta_tamax')) }} AS pconsulta_tamax,
            {{ process_null(remove_double_quotes('pconsulta_tamin')) }} AS pconsulta_tamin,
            {{ process_null(remove_double_quotes('dta_eco')) }} AS dta_eco,
            {{ process_null(remove_double_quotes('res_mamografias_obs')) }} AS res_mamografias_obs,
            {{ process_null(remove_double_quotes('cons_seguintes_perimetro_abdominal')) }} AS cons_seguintes_perimetro_abdominal,
            {{ process_null(remove_double_quotes('primeira_consulta_idade_gestacional')) }} AS primeira_consulta_idade_gestacional,
            {{ process_null(remove_double_quotes('primeira_consulta_idade_gestacional_dias')) }} AS primeira_consulta_idade_gestacional_dias,
            {{ process_null(remove_double_quotes('res_exames_lab_toxoplasmose_igg')) }} AS res_exames_lab_toxoplasmose_igg,
            {{ process_null(remove_double_quotes('res_exames_lab_toxoplasmose_igm')) }} AS res_exames_lab_toxoplasmose_igm,
            {{ process_null(remove_double_quotes('exames_lab_cultura_ag_patologicos')) }} AS exames_lab_cultura_ag_patologicos,
            {{ process_null(remove_double_quotes('exames_lab_cultura_tsa_sensiveis')) }} AS exames_lab_cultura_tsa_sensiveis,
            {{ process_null(remove_double_quotes('exames_lab_cultura_tsa_resistentes')) }} AS exames_lab_cultura_tsa_resistentes,
            {{ process_null(remove_double_quotes('exame_ginec_vulva_vagina_outras')) }} AS exame_ginec_vulva_vagina_outras,
            {{ process_null(remove_double_quotes('colo_utero_toque_outras')) }} AS colo_utero_toque_outras,
            {{ process_null(remove_double_quotes('classificacao_gestacao_alto_risco')) }} AS classificacao_gestacao_alto_risco,
            {{ process_null(remove_double_quotes('gestante_gestacoes_num')) }} AS gestante_gestacoes_num,
            {{ process_null(remove_double_quotes('sifilis_tratamento_dose_1')) }} AS sifilis_tratamento_dose_1,
            {{ process_null(remove_double_quotes('sifilis_tratamento_dose_2')) }} AS sifilis_tratamento_dose_2,
            {{ process_null(remove_double_quotes('sifilis_tratamento_dose_3')) }} AS sifilis_tratamento_dose_3,
            {{ process_null(remove_double_quotes('sifilis_tratamento_de_parceiro')) }} AS sifilis_tratamento_de_parceiro,
            {{ process_null(remove_double_quotes('sifilis_inc_ou_efetuado_tratamento_parceiro_dose_1')) }} AS sifilis_inc_ou_efetuado_tratamento_parceiro_dose_1,
            {{ process_null(remove_double_quotes('sifilis_inc_ou_efetuado_tratamento_parceiro_dose_2')) }} AS sifilis_inc_ou_efetuado_tratamento_parceiro_dose_2,
            {{ process_null(remove_double_quotes('sifilis_inc_ou_efetuado_tratamento_parceiro_dose_3')) }} AS sifilis_inc_ou_efetuado_tratamento_parceiro_dose_3,
            {{ process_null(remove_double_quotes('sifilis_data_visita_domiciliar')) }} AS sifilis_data_visita_domiciliar,
            {{ process_null(remove_double_quotes('sifilis_motivo_visita_domiciliar')) }} AS sifilis_motivo_visita_domiciliar,
            {{ process_null(remove_double_quotes('sifilis_observacoes')) }} AS sifilis_observacoes,
            {{ process_null(remove_double_quotes('exames_lab_streptoccus_b')) }} AS exames_lab_streptoccus_b,
            {{ process_null(remove_double_quotes('exames_lab_streptoccus_b_obs')) }} AS exames_lab_streptoccus_b_obs,
            {{ process_null(remove_double_quotes('consulta_seguintes_intercorrencias')) }} AS consulta_seguintes_intercorrencias,
            {{ process_null(remove_double_quotes('exames_lab_hemoglobina_d')) }} AS exames_lab_hemoglobina_d,
            {{ process_null(remove_double_quotes('exames_lab_vdrl_titulacao')) }} AS exames_lab_vdrl_titulacao,
            {{ process_null(remove_double_quotes('sifilis_teste_rapido_sifilis_parceiro')) }} AS sifilis_teste_rapido_sifilis_parceiro,
            {{ process_null(remove_double_quotes('sifilis_vdrl_parceiro')) }} AS sifilis_vdrl_parceiro,
            {{ process_null(remove_double_quotes('cons_seguintes_placenta_posicionamento')) }} AS cons_seguintes_placenta_posicionamento,
            {{ process_null(remove_double_quotes('cons_seguintes_placenta_sinais_risco')) }} AS cons_seguintes_placenta_sinais_risco,
            {{ process_null(remove_double_quotes('cons_seguintes_placenta_maturidade')) }} AS cons_seguintes_placenta_maturidade,
            {{ process_null(remove_double_quotes('cons_seguintes_placenta_observacoes')) }} AS cons_seguintes_placenta_observacoes,
            {{ process_null(remove_double_quotes('cons_seguintes_liquido_amniotico')) }} AS cons_seguintes_liquido_amniotico,
            {{ process_null(remove_double_quotes('cons_seguintes_liquido_amniotico_observacoes')) }} AS cons_seguintes_liquido_amniotico_observacoes,
            {{ process_null(remove_double_quotes('cseguintes_cardiotocografia')) }} AS cseguintes_cardiotocografia,
            {{ process_null(remove_double_quotes('sifilis_titulacao_parceiro')) }} AS sifilis_titulacao_parceiro,
            {{ process_null(remove_double_quotes('sifilis_esquema_tratamento_parceiro')) }} AS sifilis_esquema_tratamento_parceiro,
            {{ process_null(remove_double_quotes('exames_lab_agr_testes_rapidos_hiv')) }} AS exames_lab_agr_testes_rapidos_hiv,
            {{ process_null(remove_double_quotes('exames_lab_agr_testes_rapidos_hiv_positivo')) }} AS exames_lab_agr_testes_rapidos_hiv_positivo,
            {{ process_null(remove_double_quotes('smrpuerperiodata')) }} AS smrpuerperiodata,
            {{ process_null(remove_double_quotes('smlocalparto')) }} AS smlocalparto,
            {{ process_null(remove_double_quotes('smtipoparto')) }} AS smtipoparto,
            {{ process_null(remove_double_quotes('smresivaopuerpobs')) }} AS smresivaopuerpobs,
            {{ process_null(remove_double_quotes('smpuerperioparametrospeso')) }} AS smpuerperioparametrospeso,
            {{ process_null(remove_double_quotes('smpuerperioparametrostamin')) }} AS smpuerperioparametrostamin,
            {{ process_null(remove_double_quotes('smpuerperioparametrostamax')) }} AS smpuerperioparametrostamax,
            {{ process_null(remove_double_quotes('smpuerperiocitologia')) }} AS smpuerperiocitologia,
            {{ process_null(remove_double_quotes('smpuerperioalalisesplaquetas')) }} AS smpuerperioalalisesplaquetas,
            {{ process_null(remove_double_quotes('smpuerperioalalisesglicemia')) }} AS smpuerperioalalisesglicemia,
            {{ process_null(remove_double_quotes('smpuerperioalalisescreatinina')) }} AS smpuerperioalalisescreatinina,
            {{ process_null(remove_double_quotes('smpuerperioalalisesgamagt')) }} AS smpuerperioalalisesgamagt,
            {{ process_null(remove_double_quotes('smpuerperioalalisesgot')) }} AS smpuerperioalalisesgot,
            {{ process_null(remove_double_quotes('smpuerperioalalisesgtp')) }} AS smpuerperioalalisesgtp,
            {{ process_null(remove_double_quotes('smpuerperioalalisesbilirrubinas')) }} AS smpuerperioalalisesbilirrubinas,
            {{ process_null(remove_double_quotes('smpuerperioalaliseacidourico')) }} AS smpuerperioalaliseacidourico,
            {{ process_null(remove_double_quotes('smpuerperiourocultura')) }} AS smpuerperiourocultura,
            {{ process_null(remove_double_quotes('classificacaotipoparto')) }} AS classificacaotipoparto,
            {{ process_null(remove_double_quotes('puerperiomcdtsfosfatasealcalina')) }} AS puerperiomcdtsfosfatasealcalina,
            {{ process_null(remove_double_quotes('puerperiomcdtsurinai')) }} AS puerperiomcdtsurinai,
            {{ process_null(remove_double_quotes('puerperiomcdtsurinaiobs')) }} AS puerperiomcdtsurinaiobs,
            {{ process_null(remove_double_quotes('puerperiourocultura')) }} AS puerperiourocultura,
            {{ process_null(remove_double_quotes('puerperionumcolonias')) }} AS puerperionumcolonias,
            {{ process_null(remove_double_quotes('puerperioagentespatologicos')) }} AS puerperioagentespatologicos,
            {{ process_null(remove_double_quotes('puerperiotsasensiveis')) }} AS puerperiotsasensiveis,
            {{ process_null(remove_double_quotes('puerperiotsaresistentes')) }} AS puerperiotsaresistentes,
            {{ process_null(remove_double_quotes('puerperiomcdtsurinairesulltado')) }} AS puerperiomcdtsurinairesulltado,
            {{ process_null(remove_double_quotes('puerperiotermo')) }} AS puerperiotermo,
            {{ process_null(remove_double_quotes('puerperiorazaocesareo')) }} AS puerperiorazaocesareo,
            {{ process_null(remove_double_quotes('puerperiorh')) }} AS puerperiorh,
            {{ process_null(remove_double_quotes('puerperiogamaglobulinaantid')) }} AS puerperiogamaglobulinaantid,
            {{ process_null(remove_double_quotes('puerperiogamaglobulinaantiddata')) }} AS puerperiogamaglobulinaantiddata,
            {{ process_null(remove_double_quotes('gestantepuerperionumrecemnascidos')) }} AS gestantepuerperionumrecemnascidos,
            {{ process_null(remove_double_quotes('gestantepuerperioamamentacao')) }} AS gestantepuerperioamamentacao,
            {{ process_null(remove_double_quotes('puerperiodataaborto')) }} AS puerperiodataaborto,
            {{ process_null(remove_double_quotes('puerperiotipoaborto')) }} AS puerperiotipoaborto,
            {{ process_null(remove_double_quotes('puerperioidadegestacao')) }} AS puerperioidadegestacao,
            {{ process_null(remove_double_quotes('gestantepuerperiocuretagem')) }} AS gestantepuerperiocuretagem,
            {{ process_null(remove_double_quotes('puerperiooutrotermoqual')) }} AS puerperiooutrotermoqual,
   
            {{ remove_double_quotes('extracted_at') }} AS extracted_at

        FROM prenatal_deduplicados
    )

SELECT
    *
FROM fato_prenatal